<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swagger UI - CRUD Example</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.5.0/swagger-ui.css">
</head>
<body>
    <div id="swagger-ui"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.5.0/swagger-ui-bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/swagger-ui/4.5.0/swagger-ui-standalone-preset.js"></script>



    <script type="module">
        import {Rucula} from 'https://cdn.jsdelivr.net/gh/reginaldo-marinho/rucula-js@desenv/dist/Rucula.js'

        document.addEventListener('DOMContentLoaded', () => {
            const swaggerConfig = {
                openapi: "3.0.0",
                info: {
                    title: "Product API",
                    version: "1.0.0",
                    description: "A simple CRUD API for managing products"
                },
                paths: {
                    "/products": {
                        get: {
                            summary: "Get all products",
                            operationId: "getProducts",
                            tags: ["Products"],
                            responses: {
                                "200": {
                                    description: "A list of products",
                                    content: {
                                        "application/json": {
                                            schema: {
                                                type: "array",
                                                items: {
                                                    $ref: "#/components/schemas/Product"
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        post: {
                            summary: "Create a new product",
                            operationId: "createProduct",
                            tags: ["Products"],
                            requestBody: {
                                required: true,
                                content: {
                                    "application/json": {
                                        schema: {
                                            $ref: "#/components/schemas/Product"
                                        }
                                    }
                                }
                            },
                            responses: {
                                "201": {
                                    description: "Product created successfully"
                                }
                            }
                        }
                    },
                    "/products/{id}": {
                        get: {
                            summary: "Get a product by ID",
                            operationId: "getProductById",
                            tags: ["Products"],
                            parameters: [
                                {
                                    name: "id",
                                    in: "path",
                                    required: true,
                                    schema: {
                                        type: "string"
                                    }
                                }
                            ],
                            responses: {
                                "200": {
                                    description: "Product details",
                                    content: {
                                        "application/json": {
                                            schema: {
                                                $ref: "#/components/schemas/Product"
                                            }
                                        }
                                    }
                                },
                                "404": {
                                    description: "Product not found"
                                }
                            }
                        },
                        put: {
                            summary: "Update a product by ID",
                            operationId: "updateProduct",
                            tags: ["Products"],
                            parameters: [
                                {
                                    name: "id",
                                    in: "path",
                                    required: true,
                                    schema: {
                                        type: "string"
                                    }
                                }
                            ],
                            requestBody: {
                                required: true,
                                content: {
                                    "application/json": {
                                        schema: {
                                            $ref: "#/components/schemas/Product"
                                        }
                                    }
                                }
                            },
                            responses: {
                                "200": {
                                    description: "Product updated successfully"
                                },
                                "404": {
                                    description: "Product not found"
                                }
                            }
                        },
                        delete: {
                            summary: "Delete a product by ID",
                            operationId: "deleteProduct",
                            tags: ["Products"],
                            parameters: [
                                {
                                    name: "id",
                                    in: "path",
                                    required: true,
                                    schema: {
                                        type: "string"
                                    }
                                }
                            ],
                            responses: {
                                "204": {
                                    description: "Product deleted successfully"
                                },
                                "404": {
                                    description: "Product not found"
                                }
                            }
                        }
                    }
                },
                components: {
                    schemas: {
                        Product: {
                            type: "object",
                            properties: {
                                id: {
                                    type: "string",
                                    example: "12345"
                                },
                                name: {
                                    type: "string",
                                    example: "Example Product"
                                },
                                description: {
                                    type: "string",
                                    example: "A detailed description of the example product."
                                },
                                price: {
                                    type: "number",
                                    example: 29.99
                                },
                                category: {
                                    type: "string",
                                    example: "Electronics"
                                },
                                address: {
                                    type: "object",
                                    properties: {
                                        cep: {
                                            type: "string",
                                            example: "12345-678"
                                        },
                                        logradouro: {
                                            type: "string",
                                            example: "Rua Exemplo"
                                        }
                                    },
                                    required: ["cep", "logradouro"]
                                },
                                items: { // Novo array de itens adicionado
                                    type: "array",
                                    items: {
                                        type: "object",
                                        properties: {
                                            itemId: {
                                                type: "string",
                                                example: "item123"
                                            },
                                            itemName: {
                                                type: "string",
                                                example: "Example Item"
                                            },
                                            quantity: {
                                                type: "integer",
                                                example: 2
                                            },
                                            price: {
                                                type: "number",
                                                example: 10.99
                                            }
                                        },
                                        required: ["itemId", "itemName", "quantity"]
                                    }
                                }
                            },
                            required: ["name", "price"]
                        }
                    }
                }
            };

            let rucula
            let ui = SwaggerUIBundle({
                spec: swaggerConfig,
                dom_id: '#swagger-ui',
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                layout: "BaseLayout",
                onComplete: function(e) {

                    let targetNode = document.getElementById("swagger-ui")
                    
                    const config = { childList: true, subtree: true };

                    const callback = (mutationList, observer) => {
                        for (const mutation of mutationList) {
                            if (mutation.type === "childList" ) {
                                                                
                                if((mutation.target.classList.contains("opblock-body"))  && mutation.previousSibling != null) {
                                    
                                    let target = mutation.target
                                    let btnRucula = target.querySelector(".btn.try-out__btn.btn-rucula")
                                    if(btnRucula){
                                        return
                                    }

                                    
                                    let btn = target.querySelector(".btn.try-out__btn")
                                    
                                    let method = target.parentNode.parentNode.querySelector('.opblock-summary-method').textContent
                                                                        
                                    let bntRucula = btn.cloneNode(true)
                                    bntRucula.classList.add('btn-rucula')
                                    bntRucula.textContent = "Rucula"
                                    btn.after(bntRucula)
                                    
                                    let newId = `__${Date.now().toString()}` 
                                    
                                    let container = target.querySelector('.parameters-container')

                                    container.id = newId

                                    bntRucula.addEventListener('click',() => {

                                        btn.click()

                                        let code = target.querySelector("textarea.body-param__text")
                                        let objectFrame = JSON.parse(code.textContent)

                                        let config = {
                                            floatLabel:true,
                                            environments:[{
                                                description:"swagger",
                                                env:"swagger"
                                            }],
                                            localizations:[{}]
                                        }   

                                        let input = createCondfiguration(objectFrame)


                                        if(method === "POST") input.crud = 'c'
                                        if(method === "GET") input.crud = 'r'
                                        if(method === "PUT") input.crud = 'u'
                                        if(method === "DELETE") input.crud = 'd'

                                        rucula = new Rucula({
                                            global: config,
                                            window: input,
                                            id: newId
                                        })
                                        
                                        rucula.event.on('rucula.load',() => {
                                            rucula.elementRucula.querySelector('#r-a-reload').className = 'r-display-none'
                                            rucula.elementRucula.querySelector('#alter-theme').className = 'r-display-none'
                                            rucula.elementRucula.querySelector('.actions-view').className = 'r-display-none'
                                            
                                            document.querySelector(`#${newId} .r-head.r-read-new.r-facede-action.top`).innerHTML = ""
                                            
                                            
                                        })

                                        rucula.create();

                                        let event
                                        if(method === "POST") event = 'r-a-save'
                                        if(method === "PUT") input.crud = 'r-a-alter'
                                        if(method === "DELETE") input.crud = 'r-a-delete'

                                        rucula.event.on('r-a-save',() => {
                                            target.querySelector('.btn.execute').click()
                                            code.value = JSON.stringify(rucula.object())
                                        })
                                    })
                                }
                            }
                        }
                    }

                    const observer = new MutationObserver(callback);

                    observer.observe(targetNode, config);

                    function createCondfiguration(objectFrame){
                        
                        let input = new Object({
                                    type: "crud",
                                    grid:false,
                                    frames: [],
                                    layout:{
                                        items:[]
                                    },
                                    button: [
                                        {
                                            type: "button",
                                            target: "r-a-save",
                                            body:"."
                                        },
                                        {
                                            type: "button",
                                            target: "r-a-alter",
                                            body:"."
                                        },
                                        {
                                            type: "button",
                                            target: "r-a-delete",
                                            body:"."
                                        },
                                        {
                                            text: "📚 Documentação",
                                            type: "link",
                                            link:"https://swagger.io/docs/open-source-tools/swagger-ui/customization/overview/"
                                        },
                                        {
                                            text: "⭐GitHub",
                                            type: "link",
                                            link:"https://github.com/reginaldo-marinho/Rucula.Swagger"
                                        },
                                        {
                                            text: "😁 ??",
                                            type: "link",
                                            link:"https://github.com/reginaldo-marinho"
                                        }
                                    ]
                        })
                                                        
                        let identity = 1

                        input.layout.items.push([`_alias_${identity}`])
                        
                        createFrames(objectFrame,{
                                objectDto: ``,
                                alias: `_alias_${identity}`,
                        })
                        
                        function createFrames(ob, frame, parent = "."){
                            
                            identity++
                            
                            frame.fields = []
                            
                            for (var [key, value] of Object.entries(ob)) {

                                if(Array.isArray(value)){
                                        createFrames(value[0], cFrame(identity,key,parent, 'line'))    
                                        continue
                                }

                                if(typeof value === 'object'){
                                    createFrames(value,cFrame(identity, key, parent))
                                    continue
                                }


                                frame.fields.push({
                                    propertDto: key,
                                    description: key
                                })
                            }

                            function cFrame(identity, name, parent ,type='block' ){
                                
                                input.layout.items.push([`_alias_${identity}`])

                                return {
                                    objectDto: name,
                                    alias: `_alias_${identity}`,
                                    type:type,
                                    parent:parent,
                                    name:name
                                }
                            }
                            input.frames.push(frame)    
                        }   
                        
                    return input
                }
                }
                ,
                requestInterceptor: (request) => {
                    rucula.loader.enable()
                },
                responseInterceptor: (repsonse) => {
                    setTimeout(() => {
                        rucula.loader.disable()
                        rucula.popup.error({
                            text:"Informações Registradas", 
                            timeout:1500, 
                            disableadFooter:true
                        })
                        
                    },1000)
                    
                },
            })
        });

    
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/reginaldo-marinho/rucula-js@desenv/dist/style/style.css"/>

</body>
</html>
